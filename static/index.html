<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <script src="/wasm_exec.js"></script>
    <script src="/lib.js"></script>
    <title>TiDB SQL Parser</title>
    <style rel="stylesheet">
        .block {
            margin-top: 16px;
        }

        .block:before {
            font-size: 14px;
            font-weight: bold;
        }

        .block.block-in:before {
            content: "In (JavaScript)";
            color: darkred;
        }

        .block.block-out:before {
            content: "Out (JSON)";
            color: darkgreen;
        }

        html {
            font-size: 12px;
        }

        body {
            max-width: 1080px;
            margin: auto;
        }
    </style>

    <script>
        async function __onInit() {
            function blk(type, c) {
                const div = document.createElement('div')
                div.classList.add('block', 'block-' + type)
                div.appendChild(c)
                return div
            }

            function cb(lang, content) {
                const pre = document.createElement('pre')
                // const code = document.createElement('code')
                // pre.appendChild(code)
                pre.classList.add(`language-${lang}`)
                pre.textContent = content
                Prism?.highlightElement(pre)
                return pre
            }

            function _eval(expr) {
                document.body.appendChild(blk('in', cb('javascript', expr)))
                const res = eval(expr)
                document.body.appendChild(blk('out', cb('json', JSON.stringify(res, undefined, 2))))
            }

            const schema = await fetch(document.baseURI + 'schema.sql').then(res => res.text())
            const query = await fetch(document.baseURI + 'query.sql').then(res => res.text())

            _eval(`p = new Parser()`)
            _eval(`// Define function types
p.defineTransparentFunc("IFNULL");
p.defineTransparentFunc("SUM");
p.defineTransparentFunc("ABS");
p.defineTransparentFunc("GREATEST");
p.defineTransparentFunc("LEAST");
p.defineFunc("DATE_SUB", 'ETDatetime', false);
p.defineFunc("COUNT", 'ETInt', false);
p.defineFunc("TIMESTAMPDIFF", 'ETReal', false);
`);
            _eval(`// original OSSInsight DDL
p.addDdl(schema)`)
            _eval(`// https://github.com/pingcap/ossinsight/blob/main/api/queries/trending-repos/template.sql
p.parse(query)`);
        }
    </script>
    <script>
        window.addEventListener('parserloaded', () => {
            document.getElementById('loading')?.remove()
        })
    </script>
</head>
<body>
<h1>TiDB Sql Parser Demo</h1>
<div id="loading">Loading Parser wasm</div>
<pre id="code" class="language-javascript">
// exported global variables
// __tidbSqlParserEvalTypes: string[]
// __tidbSqlParserExecuteCmd: (cmd: int, ...args) => result

class Parser {
    constructor() {
        this.open()
    }

    get isOpen() {
        return __tidbSqlParserExecuteCmd(0).Data
    }

    open() {
        console.debug('[tidb-sql-parser] open parser')
        return __tidbSqlParserExecuteCmd(1)
    }

    addDdl(sql) {
        console.debug('[tidb-sql-parser] add ddl:', sql)
        return __tidbSqlParserExecuteCmd(3, sql)
    }

    defineFunc(func, type, nullable) {
        console.debug('[tidb-sql-parser] define function:', func, type, nullable)
        return __tidbSqlParserExecuteCmd(4, func, evalTypes[type], nullable)
    }

    parse(sql) {
        console.debug('[tidb-sql-parser] parse:', sql)
        return __tidbSqlParserExecuteCmd(5, sql)
    }

    getTable (name) {
        console.debug('[tidb-sql-parser] get table:', name)
        return __tidbSqlParserExecuteCmd(6, name)
    }

    defineTransparentFunc (name) {
        console.debug('[tidb-sql-parser] define transparent func:', name)
        return __tidbSqlParserExecuteCmd(7, name)
    }

    close() {
        console.debug('[tidb-sql-parser] open close')
        return __tidbSqlParserExecuteCmd(2)
    }

    static normalizeDigest (sql) {
        return __tidbSqlParserExecuteCmd(8, sql)
    }
}
</pre>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"
        integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"
        integrity="sha512-jwrwRWZWW9J6bjmBOJxPcbRvEBSQeY4Ad0NEXSfP0vwYi/Yu9x5VhDBl3wz6Pnxs8Rx/t1P8r9/OHCRciHcT7Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"
        integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
      integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script>
    Prism.highlightElement(document.getElementById('code'))
</script>
</body>
</html>
